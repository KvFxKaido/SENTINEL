---
import GameLayout from '../layouts/GameLayout.astro';
import Header from '../components/Header.astro';
import NarrativeLog from '../components/NarrativeLog.astro';
import CommandInput from '../components/CommandInput.astro';
---

<GameLayout title="SENTINEL">
  <Header />

  <aside class="left-panel">
    <div class="tui-panel self-panel">
      <div class="tui-panel-title">SELF</div>

      <div class="tui-section">
        <div class="character-name" id="char-name">—</div>
        <div class="character-background" id="char-background">[No character]</div>
      </div>

      <div class="tui-section">
        <div class="tui-section-header">-- STATUS --</div>
        <div class="status-row">
          <span class="status-label">Pistachios</span>
          <div class="progress-bar" id="energy-bar">
            <div class="progress-fill" id="energy-fill" style="width: 75%"></div>
          </div>
          <span class="status-value" id="energy-value">—</span>
        </div>
        <div class="status-row">
          <span class="status-label">Credits</span>
          <span class="status-value mono" id="credits-value">—</span>
        </div>
        <div class="status-row">
          <span class="status-label">Location</span>
          <span class="status-value" id="location-value">—</span>
        </div>
        <div class="status-row">
          <span class="status-label">Region</span>
          <span class="status-value" id="region-value">—</span>
        </div>
      </div>

      <div class="tui-section">
        <div class="tui-section-header">-- LOADOUT --</div>
        <div class="loadout-list" id="loadout-list">
          <div class="loadout-item muted">[Empty]</div>
        </div>
      </div>

      <div class="tui-section">
        <div class="tui-section-header">-- ENHANCEMENTS --</div>
        <div class="enhancement-list" id="enhancement-list">
          <div class="enhancement-item muted">[None]</div>
        </div>
      </div>
    </div>
  </aside>

  <main class="main-content">
    <NarrativeLog />
  </main>

  <aside class="right-panel">
    <div class="tui-panel world-panel">
      <div class="tui-panel-title">WORLD</div>

      <div class="tui-section">
        <div class="tui-section-header">-- STANDINGS --</div>
        <div class="standings-list" id="standings-list">
          <!-- Populated dynamically -->
        </div>
      </div>

      <div class="tui-section">
        <div class="tui-section-header">-- THREADS --</div>
        <div class="threads-list" id="threads-list">
          <div class="thread-item muted">[No active threads]</div>
        </div>
      </div>

      <div class="tui-section">
        <div class="tui-section-header">-- EVENTS --</div>
        <div class="event-log" id="event-log">
          <div class="event-entry muted">Waiting...</div>
        </div>
      </div>
    </div>
  </aside>

  <footer class="command-area">
    <CommandInput />
  </footer>
</GameLayout>

<style>
  .left-panel {
    grid-column: 1;
    grid-row: 2;
    overflow-y: auto;
  }

  .main-content {
    grid-column: 2;
    grid-row: 2;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .right-panel {
    grid-column: 3;
    grid-row: 2;
    overflow-y: auto;
  }

  .command-area {
    grid-column: 1 / -1;
    grid-row: 3;
  }

  /* TUI Panel Styles */
  .tui-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    padding: var(--space-sm);
    height: 100%;
    overflow-y: auto;
  }

  .tui-panel-title {
    text-align: center;
    color: var(--accent-cyan);
    font-weight: bold;
    letter-spacing: 0.1em;
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--border-color);
    margin-bottom: var(--space-sm);
  }

  .tui-section {
    margin-bottom: var(--space-md);
  }

  .tui-section:last-child {
    margin-bottom: 0;
  }

  .tui-section-header {
    color: var(--text-muted);
    font-size: 0.65rem;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-xs);
  }

  /* Character */
  .character-name {
    color: var(--accent-steel);
    font-weight: bold;
    text-transform: uppercase;
  }

  .character-background {
    color: var(--text-muted);
    font-size: 0.65rem;
  }

  /* Status rows */
  .status-row {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-bottom: 2px;
  }

  .status-label {
    color: var(--text-secondary);
    min-width: 70px;
  }

  .status-value {
    color: var(--text-primary);
    margin-left: auto;
  }

  /* Progress bar */
  .progress-bar {
    flex: 1;
    height: 8px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--accent-cyan);
    transition: width 0.3s ease;
  }

  .progress-fill.low {
    background: var(--status-danger);
  }

  .progress-fill.medium {
    background: var(--status-warning);
  }

  /* Loadout & Enhancements */
  .loadout-list, .enhancement-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .loadout-item {
    color: var(--text-secondary);
    padding-left: var(--space-xs);
    font-size: 0.7rem;
  }

  .loadout-item.equipped {
    color: var(--accent-cyan);
  }

  .loadout-item.used {
    color: var(--text-muted);
    text-decoration: line-through;
  }

  .enhancement-item {
    color: var(--faction-convergence);
    padding-left: var(--space-xs);
    font-size: 0.7rem;
  }

  /* Standings */
  .standings-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  :global(.standing-row) {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  :global(.standing-name) {
    color: var(--text-secondary);
    min-width: 75px;
    font-size: 0.7rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  :global(.standing-bar) {
    flex: 1;
    height: 6px;
    background: var(--bg-tertiary);
  }

  :global(.standing-fill) {
    height: 100%;
    transition: width 0.3s ease;
  }

  :global(.standing-fill.hostile) { background: var(--status-danger); }
  :global(.standing-fill.unfriendly) { background: #f0883e; }
  :global(.standing-fill.neutral) { background: var(--text-muted); }
  :global(.standing-fill.friendly) { background: var(--status-success); }
  :global(.standing-fill.allied) { background: var(--accent-cyan); }

  :global(.standing-label) {
    font-size: 0.6rem;
    min-width: 50px;
    text-align: right;
  }

  :global(.standing-label.hostile) { color: var(--status-danger); }
  :global(.standing-label.unfriendly) { color: #f0883e; }
  :global(.standing-label.neutral) { color: var(--text-muted); }
  :global(.standing-label.friendly) { color: var(--status-success); }
  :global(.standing-label.allied) { color: var(--accent-cyan); }

  /* Threads */
  .threads-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  :global(.thread-item) {
    display: flex;
    align-items: flex-start;
    gap: var(--space-xs);
    font-size: 0.7rem;
  }

  :global(.thread-icon) {
    color: var(--status-warning);
  }

  :global(.thread-text) {
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Event log */
  .event-log {
    max-height: 100px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  :global(.event-entry) {
    font-size: 0.65rem;
    color: var(--text-secondary);
    padding: 2px var(--space-xs);
  }

  :global(.event-entry .event-type) {
    color: var(--accent-cyan);
  }

  .muted {
    color: var(--text-muted);
    font-style: italic;
  }

  .connection-error {
    text-align: center;
    padding: var(--space-xl);
    color: var(--text-secondary);
  }

  .connection-error h3 {
    color: var(--status-warning);
    margin-bottom: var(--space-md);
  }

  .connection-error pre {
    background: var(--bg-tertiary);
    padding: var(--space-md);
    border-radius: var(--border-radius);
    margin: var(--space-md) 0;
    font-family: var(--font-mono);
    color: var(--accent-cyan);
  }

  @media (max-width: 1000px) {
    .left-panel, .right-panel {
      display: none;
    }

    .main-content {
      grid-column: 1 / -1;
    }
  }
</style>

<script>
  import { subscribeToEvents, getState, checkHealth, getCampaignState, type CampaignState } from '../lib/bridge';

  // Standing to display info
  const STANDING_INFO: Record<string, { width: number; class: string }> = {
    hostile: { width: 10, class: 'hostile' },
    unfriendly: { width: 30, class: 'unfriendly' },
    neutral: { width: 50, class: 'neutral' },
    friendly: { width: 70, class: 'friendly' },
    allied: { width: 90, class: 'allied' },
  };

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', async () => {
    const healthy = await checkHealth();
    const statusDot = document.querySelector('.bridge-status .status-dot');

    if (healthy) {
      statusDot?.classList.add('ready');

      try {
        const state = await getState();
        updateBridgeUI(state);

        if (state.sentinel?.campaign) {
          const campaignState = await getCampaignState();
          if (campaignState.ok) {
            updateCampaignUI(campaignState);
          }
        }
      } catch (err) {
        console.error('Failed to get initial state:', err);
      }

      subscribeToEvents((event) => {
        console.log('Event received:', event);
        handleEvent(event);
      });
    } else {
      statusDot?.classList.add('error');
      showConnectionError();
    }
  });

  function updateBridgeUI(state: any) {
    const bridgeState = document.getElementById('bridge-state');
    if (bridgeState) {
      bridgeState.textContent = state.state;
    }

    const backendInfo = document.getElementById('backend-info');
    if (backendInfo && state.sentinel?.backend) {
      backendInfo.textContent = `${state.sentinel.backend.backend} (${state.sentinel.backend.model})`;
    }

    const campaignInfo = document.getElementById('campaign-info');
    if (campaignInfo) {
      if (state.sentinel?.campaign) {
        campaignInfo.textContent = `${state.sentinel.campaign.name} (Session ${state.sentinel.campaign.session})`;
      } else {
        campaignInfo.textContent = 'No campaign';
      }
    }
  }

  function updateCampaignUI(state: CampaignState) {
    // Character info
    const charName = document.getElementById('char-name');
    const charBg = document.getElementById('char-background');
    if (charName && state.character) {
      charName.textContent = state.character.name || '—';
    }
    if (charBg && state.character) {
      charBg.textContent = state.character.background ? `[${formatLabel(state.character.background)}]` : '[No background]';
    } else if (charBg) {
      charBg.textContent = '[No character]';
    }

    // Energy
    const energyFill = document.getElementById('energy-fill');
    const energyValue = document.getElementById('energy-value');
    if (energyFill && energyValue && state.character) {
      const percent = Math.round((state.character.social_energy.current / state.character.social_energy.max) * 100);
      energyFill.style.width = `${percent}%`;
      energyValue.textContent = `${percent}%`;

      energyFill.classList.remove('low', 'medium');
      if (percent <= 25) energyFill.classList.add('low');
      else if (percent <= 50) energyFill.classList.add('medium');
    }

    // Credits
    const creditsValue = document.getElementById('credits-value');
    if (creditsValue && state.character) {
      creditsValue.textContent = `${state.character.credits}c`;
    }

    // Location & Region
    const locationValue = document.getElementById('location-value');
    const regionValue = document.getElementById('region-value');
    if (locationValue) {
      locationValue.textContent = formatLabel(state.location);
    }
    if (regionValue) {
      regionValue.textContent = formatLabel(state.region);
    }

    // Standings
    updateStandingsList(state.factions);

    // Gear/Loadout
    updateGearList(state.character?.gear || [], state.loadout || []);

    // Enhancements
    updateEnhancementsList(state.character?.enhancements || []);
  }

  function updateGearList(gear: CampaignState['character']['gear'], loadout: string[]) {
    const container = document.getElementById('loadout-list');
    if (!container) return;

    container.innerHTML = '';

    if (gear.length === 0) {
      container.innerHTML = '<div class="loadout-item muted">[Empty]</div>';
      return;
    }

    for (const item of gear) {
      const inLoadout = loadout.includes(item.id);
      const div = document.createElement('div');
      div.className = `loadout-item${item.used ? ' used' : ''}${inLoadout ? ' equipped' : ''}`;
      div.innerHTML = `${inLoadout ? '▸ ' : '  '}${item.name}${item.used ? ' (used)' : ''}`;
      div.title = item.category;
      container.appendChild(div);
    }
  }

  function updateEnhancementsList(enhancements: CampaignState['character']['enhancements']) {
    const container = document.getElementById('enhancement-list');
    if (!container) return;

    container.innerHTML = '';

    if (enhancements.length === 0) {
      container.innerHTML = '<div class="enhancement-item muted">[None]</div>';
      return;
    }

    for (const enh of enhancements) {
      const div = document.createElement('div');
      div.className = 'enhancement-item';
      div.innerHTML = `▸ ${enh.name}`;
      div.title = `${enh.source}: ${enh.benefit}`;
      container.appendChild(div);
    }
  }

  function updateStandingsList(factions: CampaignState['factions']) {
    const container = document.getElementById('standings-list');
    if (!container) return;

    container.innerHTML = '';

    // Sort factions: allied/friendly first, then neutral, then hostile
    const sorted = [...factions].sort((a, b) => {
      const order = ['allied', 'friendly', 'neutral', 'unfriendly', 'hostile'];
      return order.indexOf(a.standing.toLowerCase()) - order.indexOf(b.standing.toLowerCase());
    });

    for (const faction of sorted) {
      const standingKey = faction.standing.toLowerCase();
      const info = STANDING_INFO[standingKey] || STANDING_INFO.neutral;

      const row = document.createElement('div');
      row.className = 'standing-row';
      row.innerHTML = `
        <span class="standing-name">${abbreviateFaction(faction.name)}</span>
        <div class="standing-bar">
          <div class="standing-fill ${info.class}" style="width: ${info.width}%"></div>
        </div>
        <span class="standing-label ${info.class}">${faction.standing}</span>
      `;
      container.appendChild(row);
    }
  }

  function abbreviateFaction(name: string): string {
    const abbrevs: Record<string, string> = {
      'Steel Syndicate': 'Steel Synd.',
      'Ember Colonies': 'Ember Colon.',
      'Ghost Networks': 'Ghost Net.',
    };
    return abbrevs[name] || name;
  }

  function formatLabel(str: string): string {
    return str.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  async function handleEvent(event: any) {
    const log = document.getElementById('event-log');
    if (log) {
      const waiting = log.querySelector('.muted');
      if (waiting) waiting.remove();

      const entry = document.createElement('div');
      entry.className = 'event-entry fade-in';
      entry.innerHTML = `<span class="event-type">${event.event_type || 'unknown'}</span>`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;

      while (log.children.length > 15) {
        log.removeChild(log.firstChild!);
      }
    }

    const refreshEvents = ['campaign.loaded', 'faction.changed', 'social_energy.changed', 'session.started', 'session.ended'];
    if (refreshEvents.includes(event.event_type)) {
      try {
        const campaignState = await getCampaignState();
        if (campaignState.ok) {
          updateCampaignUI(campaignState);
        }
      } catch (err) {
        console.error('Failed to refresh campaign state:', err);
      }
    }
  }

  function showConnectionError() {
    const log = document.getElementById('narrative-log');
    if (log) {
      log.innerHTML = `
        <div class="connection-error">
          <h3>Bridge Not Connected</h3>
          <p>Start the Deno bridge to connect:</p>
          <pre>cd sentinel-bridge && deno task dev</pre>
          <p>Then refresh this page.</p>
        </div>
      `;
    }
  }

  // Global refresh functions
  (window as any).refreshCampaignState = async () => {
    try {
      const campaignState = await getCampaignState();
      if (campaignState.ok) {
        updateCampaignUI(campaignState);
      }
    } catch (err) {
      console.error('Failed to refresh campaign state:', err);
    }
  };

  (window as any).refreshBridgeState = async () => {
    try {
      const state = await getState();
      updateBridgeUI(state);
    } catch (err) {
      console.error('Failed to refresh bridge state:', err);
    }
  };
</script>
