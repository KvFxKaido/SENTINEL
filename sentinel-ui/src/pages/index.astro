---
import GameLayout from '../layouts/GameLayout.astro';
import Header from '../components/Header.astro';
import NarrativeLog from '../components/NarrativeLog.astro';
import SidePanel from '../components/SidePanel.astro';
import CommandInput from '../components/CommandInput.astro';
---

<GameLayout title="SENTINEL">
  <Header />

  <main class="main-content">
    <NarrativeLog />
  </main>

  <aside class="side-panel">
    <SidePanel />
  </aside>

  <footer class="command-area">
    <CommandInput />
  </footer>
</GameLayout>

<style>
  .main-content {
    grid-column: 1;
    grid-row: 2;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .side-panel {
    grid-column: 2;
    grid-row: 1 / -1;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    overflow-y: auto;
  }

  .command-area {
    grid-column: 1;
    grid-row: 3;
  }

  @media (max-width: 900px) {
    .side-panel {
      grid-column: 1;
      grid-row: 3;
      flex-direction: row;
      flex-wrap: wrap;
    }

    .command-area {
      grid-row: 4;
    }
  }
</style>

<script>
  import { subscribeToEvents, getState, checkHealth, getCampaignState, type CampaignState } from '../lib/bridge';

  // Standing to CSS class mapping
  const STANDING_CLASSES: Record<string, string> = {
    hostile: 'disposition-hostile',
    unfriendly: 'disposition-wary',
    neutral: 'disposition-neutral',
    friendly: 'disposition-warm',
    allied: 'disposition-loyal',
  };

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', async () => {
    // Check if bridge is available
    const healthy = await checkHealth();
    const statusDot = document.querySelector('.bridge-status .status-dot');

    if (healthy) {
      statusDot?.classList.add('ready');

      // Get initial state
      try {
        const state = await getState();
        updateBridgeUI(state);

        // If a campaign is loaded, get detailed state
        if (state.sentinel?.campaign) {
          const campaignState = await getCampaignState();
          if (campaignState.ok) {
            updateCampaignUI(campaignState);
          }
        }
      } catch (err) {
        console.error('Failed to get initial state:', err);
      }

      // Subscribe to events
      subscribeToEvents((event) => {
        console.log('Event received:', event);
        handleEvent(event);
      });
    } else {
      statusDot?.classList.add('error');
      showConnectionError();
    }
  });

  function updateBridgeUI(state: any) {
    // Update connection status
    const bridgeState = document.getElementById('bridge-state');
    if (bridgeState) {
      bridgeState.textContent = state.state;
    }

    // Update backend info
    const backendInfo = document.getElementById('backend-info');
    if (backendInfo && state.sentinel?.backend) {
      backendInfo.textContent = `${state.sentinel.backend.backend} (${state.sentinel.backend.model})`;
    }

    // Update campaign info
    const campaignInfo = document.getElementById('campaign-info');
    if (campaignInfo) {
      if (state.sentinel?.campaign) {
        campaignInfo.textContent = `${state.sentinel.campaign.name} (Session ${state.sentinel.campaign.session})`;
      } else {
        campaignInfo.textContent = 'No campaign loaded';
      }
    }
  }

  function updateCampaignUI(state: CampaignState) {
    // Update state panel
    const phaseEl = document.getElementById('state-phase');
    const regionEl = document.getElementById('state-region');
    const energyEl = document.getElementById('state-energy');
    const creditsEl = document.getElementById('state-credits');

    if (phaseEl) {
      // Session phase or campaign phase
      if (state.session_phase) {
        phaseEl.textContent = state.session_phase.replace('_', ' ').toUpperCase();
      } else {
        phaseEl.textContent = state.location.replace('_', ' ').toUpperCase();
      }
    }

    if (regionEl) {
      regionEl.textContent = state.region.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    if (energyEl && state.character) {
      const energy = state.character.social_energy;
      const percent = Math.round((energy.current / energy.max) * 100);
      energyEl.textContent = `${energy.current}/${energy.max}`;
      // Color based on level
      if (percent <= 25) {
        energyEl.style.color = 'var(--status-danger)';
      } else if (percent <= 50) {
        energyEl.style.color = 'var(--status-warning)';
      } else {
        energyEl.style.color = 'var(--text-primary)';
      }
    }

    if (creditsEl && state.character) {
      creditsEl.textContent = `${state.character.credits}c`;
    }

    // Update factions list
    updateFactionsList(state.factions);
  }

  function updateFactionsList(factions: CampaignState['factions']) {
    const container = document.getElementById('faction-list');
    if (!container) return;

    // Clear existing content
    container.innerHTML = '';

    // Add each faction
    for (const faction of factions) {
      const item = document.createElement('div');
      item.className = 'faction-item';

      const name = document.createElement('span');
      name.className = 'faction-name';
      name.textContent = faction.name;

      const standing = document.createElement('span');
      const standingClass = STANDING_CLASSES[faction.standing.toLowerCase()] || 'disposition-neutral';
      standing.className = `faction-standing ${standingClass}`;
      standing.textContent = faction.standing.toUpperCase();

      item.appendChild(name);
      item.appendChild(standing);
      container.appendChild(item);
    }
  }

  async function handleEvent(event: any) {
    // Add event to log
    const log = document.getElementById('event-log');
    if (log) {
      // Remove "Waiting for events..." message
      const waiting = log.querySelector('.muted');
      if (waiting) waiting.remove();

      const entry = document.createElement('div');
      entry.className = 'event-entry fade-in';
      entry.innerHTML = `<span class="event-type">${event.event_type || 'unknown'}</span>`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;

      // Keep only last 20 events
      while (log.children.length > 20) {
        log.removeChild(log.firstChild!);
      }
    }

    // Refresh campaign state on relevant events
    const refreshEvents = ['campaign.loaded', 'faction.changed', 'social_energy.changed', 'session.started', 'session.ended'];
    if (refreshEvents.includes(event.event_type)) {
      try {
        const campaignState = await getCampaignState();
        if (campaignState.ok) {
          updateCampaignUI(campaignState);
        }
      } catch (err) {
        console.error('Failed to refresh campaign state:', err);
      }
    }
  }

  function showConnectionError() {
    const log = document.getElementById('narrative-log');
    if (log) {
      log.innerHTML = `
        <div class="connection-error">
          <h3>Bridge Not Connected</h3>
          <p>Start the Deno bridge to connect:</p>
          <pre>cd sentinel-bridge && deno task dev</pre>
          <p>Then refresh this page.</p>
        </div>
      `;
    }
  }

  // Expose refresh functions globally for command input to use
  (window as any).refreshCampaignState = async () => {
    try {
      const campaignState = await getCampaignState();
      if (campaignState.ok) {
        updateCampaignUI(campaignState);
      }
    } catch (err) {
      console.error('Failed to refresh campaign state:', err);
    }
  };

  (window as any).refreshBridgeState = async () => {
    try {
      const state = await getState();
      updateBridgeUI(state);
    } catch (err) {
      console.error('Failed to refresh bridge state:', err);
    }
  };
</script>

<style>
  .connection-error {
    text-align: center;
    padding: var(--space-xl);
    color: var(--text-secondary);
  }

  .connection-error h3 {
    color: var(--status-warning);
    margin-bottom: var(--space-md);
  }

  .connection-error pre {
    background: var(--bg-tertiary);
    padding: var(--space-md);
    border-radius: var(--border-radius);
    margin: var(--space-md) 0;
    font-family: var(--font-mono);
    color: var(--accent-cyan);
  }
</style>
